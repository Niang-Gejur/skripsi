# ===============================================================
# NA√èVE BAYES PIPELINE - MOBILE LEGENDS TWITTER
# ===============================================================

import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.naive_bayes import MultinomialNB
from sklearn.pipeline import Pipeline
from sklearn.metrics import (
    classification_report, confusion_matrix,
    accuracy_score, f1_score
)
import seaborn as sns
import matplotlib.pyplot as plt
import pickle

# ===============================================================
# 1Ô∏è‚É£ Load Dataset
# ===============================================================
df = pd.read_excel("mobilelegends_labelled.xlsx")
df.columns = df.columns.str.strip()

# Validasi kolom
required_cols = ["stemmed_text", "sentiment_label"]
for col in required_cols:
    if col not in df.columns:
        raise ValueError(f"Kolom '{col}' tidak ditemukan!")

# Hapus data kosong
df = df.dropna(subset=required_cols)

X = df["stemmed_text"].astype(str)
y = df["sentiment_label"]

# ===============================================================
# 2Ô∏è‚É£ Split Data
# ===============================================================
X_train, X_test, y_train, y_test = train_test_split(
    X, y,
    test_size=0.2,
    random_state=42,
    stratify=y
)

# ===============================================================
# 3Ô∏è‚É£ Pipeline TF-IDF + Na√Øve Bayes
# ===============================================================
nb_pipeline = Pipeline([
    ("tfidf", TfidfVectorizer(
        lowercase=True,
        ngram_range=(1, 2),
        min_df=3,
        max_df=0.85,
        sublinear_tf=True
    )),
    ("classifier", MultinomialNB())
])

# ===============================================================
# 4Ô∏è‚É£ Train Model
# ===============================================================
nb_pipeline.fit(X_train, y_train)

# ===============================================================
# 5Ô∏è‚É£ Evaluasi Model
# ===============================================================
y_pred = nb_pipeline.predict(X_test)

print("\nüîπ Akurasi Model :", round(accuracy_score(y_test, y_pred), 4))
print("üîπ F1-Score      :", round(f1_score(y_test, y_pred, average="weighted"), 4))
print("\nüîπ Classification Report:\n")
print(classification_report(y_test, y_pred))

# ===============================================================
# 6Ô∏è‚É£ Confusion Matrix
# ===============================================================
labels = sorted(y.unique())
cm = confusion_matrix(y_test, y_pred, labels=labels)

plt.figure(figsize=(7, 6))
sns.heatmap(
    cm, annot=True, fmt="d", cmap="Blues",
    xticklabels=labels, yticklabels=labels
)
plt.title("Confusion Matrix - Na√Øve Bayes (TF-IDF)")
plt.xlabel("Prediksi")
plt.ylabel("Aktual")
plt.show()

# ===============================================================
# 7Ô∏è‚É£ Simpan Model Pipeline
# ===============================================================
with open("model_nb.pkl", "wb") as f:
    pickle.dump(nb_pipeline, f)

print("‚úÖ Model Na√Øve Bayes Pipeline berhasil disimpan!")
